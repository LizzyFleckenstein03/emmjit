local f = io.open("gen.asm", "w")
f:write("; generated by gen.lua\n")

local builtin = {
    ['#'] = "pushzero",
    ['+'] = "add",
    ['-'] = "sub",
    ['~'] = "log",
    ['.'] = "output",
    [','] = "input",
    ['^'] = "enqueue",
    ['v'] = "dequeue",
    [':'] = "dup",
    ['!'] = "compile",
    ['?'] = "exec",
    [';'] = "pushsep",
}

f:write("section .text\n")
for i = 0, 9 do
    builtin[tostring(i)] = tostring(i)
    f:write("op_"..i..":\n")
    f:write("\tSTACK_PREPOP\n")
    f:write("\tmovzx rax, byte[STACK]\n")
    f:write("\tlea rax, [rax*4+rax]\n")
    f:write("\tlea rax, [rax*2+"..i.."]\n")
    f:write("\tmov [STACK], al\n")
    f:write("\t.tail: ret\n")
    f:write(".end:\n")
end

f:write("section .data\n")

local funcs = ""
for i = 0, 255 do
    funcs = funcs.."op_"..(builtin[string.char(i)] or "nop")..(i==255 and "" or ", ")
end
funcs = funcs.."\n"

f:write("instr_func_init: dq " .. funcs)
f:write("instr_func: dq " .. funcs)

f:write("instr_info: dq ")
for i = 0, 255 do
    local op = "op_"..(builtin[string.char(i)] or "nop")
    f:write(
        "("..op..".end-"..op.."), ".. -- size
        "("..op..".tail-"..op..")".. -- tail offset
        (i==255 and "" or ", "))
end
f:write("\n")
